<div class="min-h-screen p-4 sm:p-6 transition-colors duration-300" [class.bg-gradient-to-br]="!isDark()"
  [class.from-slate-50]="!isDark()" [class.to-blue-50]="!isDark()" [class.text-slate-800]="!isDark()"
  [class.bg-gray-900]="isDark()">

  <div class="max-w-6xl mx-auto">
    <!-- Header with User Info & Theme Toggle -->
    <div
      class="bg-white/80 dark:bg-gray-800/50 backdrop-blur-xl p-4 rounded-xl shadow-sm border border-white/50 dark:border-gray-700/50 mb-6 flex flex-wrap justify-between items-center gap-4"
      [@fadeIn]>
      <div class="text-slate-700 dark:text-gray-100">
        <h2 class="text-2xl font-bold tracking-tight">Welcome, {{ currentUser()?.name || 'User' }}!</h2>
        <p class="text-sm opacity-70">{{ currentUser()?.email }}</p>
      </div>

      <div class="flex items-center gap-3">
        <!-- Theme Toggle -->
        <button (click)="toggleTheme()"
          class="p-2 bg-white/50 hover:bg-white dark:bg-gray-700 dark:hover:bg-gray-600 text-slate-700 dark:text-white rounded-lg transition-all border border-slate-200 dark:border-gray-600 shadow-sm"
          title="Toggle theme">
          <span class="text-xl">{{ isDark() ? '‚òÄÔ∏è' : 'üåô' }}</span>
        </button>

        <!-- Logout -->
        <button (click)="logout()"
          class="px-4 py-2 bg-white/50 hover:bg-white dark:bg-gray-700 dark:hover:bg-gray-600 text-slate-700 dark:text-white rounded-lg transition-all border border-slate-200 dark:border-gray-600 shadow-sm font-medium">
          Logout
        </button>
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6" [@fadeIn]>
      <div
        class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-gray-700 transition-all hover:shadow-md">
        <div class="text-3xl font-bold text-blue-600 dark:text-blue-400">{{ tasks().length }}</div>
        <div class="text-sm font-medium text-slate-500 dark:text-gray-400">Total Tasks</div>
      </div>
      <div
        class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-gray-700 transition-all hover:shadow-md">
        <div class="text-3xl font-bold text-emerald-600 dark:text-green-400">{{ getCompletedCount() }}</div>
        <div class="text-sm font-medium text-slate-500 dark:text-gray-400">Completed</div>
      </div>
      <div
        class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-gray-700 transition-all hover:shadow-md">
        <div class="text-3xl font-bold text-rose-500 dark:text-orange-400">{{ overdueTasks().length }}</div>
        <div class="text-sm font-medium text-slate-500 dark:text-gray-400">Overdue</div>
      </div>
      <div
        class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-slate-100 dark:border-gray-700 transition-all hover:shadow-md">
        <div class="text-3xl font-bold text-purple-600 dark:text-purple-400">{{ tasksCompletedToday() }}</div>
        <div class="text-sm font-medium text-slate-500 dark:text-gray-400">Done Today</div>
      </div>
    </div>

    <!-- Main Card -->
    <div
      class="bg-white dark:bg-gray-800 p-6 sm:p-8 rounded-xl shadow-lg border border-slate-100 dark:border-gray-700 transition-colors duration-300">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-slate-800 dark:text-gray-100 tracking-tight">Task Manager</h1>

        <!-- Filter Toggle -->
        <button (click)="showFilters.set(!showFilters())"
          class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all shadow-md">
          {{ showFilters() ? 'Hide' : 'Show' }} Filters
        </button>
      </div>

      <!-- Filters Section -->
      @if (showFilters()) {
      <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg space-y-3" [@fadeIn]>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
          <!-- Search -->
          <input type="text" [(ngModel)]="searchQuery" (ngModelChange)="applyFilters()" placeholder="Search tasks..."
            class="p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

          <!-- Priority Filter -->
          <select [(ngModel)]="selectedPriority" (ngModelChange)="applyFilters()"
            class="p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="">All Priorities</option>
            <option value="high">üî¥ High</option>
            <option value="medium">üü° Medium</option>
            <option value="low">üü¢ Low</option>
          </select>

          <!-- Status Filter -->
          <select [(ngModel)]="selectedStatus" (ngModelChange)="applyFilters()"
            class="p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="completed">Completed</option>
          </select>

          <!-- Clear Filters -->
          <button (click)="clearFilters()"
            class="px-4 py-3 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 rounded-lg transition-all">
            Clear Filters
          </button>
        </div>

        <!-- Overdue Toggle -->
        <label class="flex items-center gap-2 cursor-pointer">
          <input type="checkbox" [(ngModel)]="showOverdueOnly" (ngModelChange)="applyFilters()"
            class="w-4 h-4 rounded border-gray-300 text-red-600 focus:ring-2 focus:ring-red-500" />
          <span class="text-sm text-gray-700 dark:text-gray-300">Show overdue tasks only</span>
        </label>
      </div>
      }

      <!-- Completion Progress Bar -->
      @if (allTasks().length > 0) {
      <div class="mb-6">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Overall Progress</span>
          <span class="text-sm font-bold text-blue-600 dark:text-blue-400">{{ completionPercentage() }}%</span>
        </div>
        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3 overflow-hidden">
          <div
            class="bg-gradient-to-r from-blue-500 to-purple-500 h-3 rounded-full transition-all duration-500 ease-out"
            [style.width.%]="completionPercentage()"></div>
        </div>
      </div>
      }

      <!-- Add Task Button -->
      @if (!showAddTaskForm()) {
      <button (click)="showAddTaskForm.set(true)"
        class="w-full mb-6 p-4 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white rounded-lg transition-all shadow-md hover:shadow-lg font-medium flex items-center justify-center gap-2"
        [@fadeIn]>
        <span class="text-xl">+</span>
        <span>Add New Task</span>
      </button>
      }

      <!-- Add Task Form -->
      @if (showAddTaskForm()) {
      <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700/50 rounded-lg space-y-3" [@fadeIn]>
        <input type="text" [(ngModel)]="newTaskTitle" (keyup.enter)="addTask()" placeholder="Task title..."
          class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
          <select [(ngModel)]="newTaskPriority"
            class="p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <option value="high">üî¥ High Priority</option>
            <option value="medium">üü° Medium Priority</option>
            <option value="low">üü¢ Low Priority</option>
          </select>

          <input type="date" [(ngModel)]="newTaskDueDate"
            class="p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
        </div>

        <input type="text" [(ngModel)]="newTaskTags" placeholder="Tags (comma-separated)..."
          class="w-full p-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />

        <div class="flex gap-3">
          <button (click)="addTask()"
            class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-md hover:shadow-lg font-medium">
            Add Task
          </button>
          <button (click)="showAddTaskForm.set(false)"
            class="px-6 py-3 bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-100 rounded-lg transition-all">
            Cancel
          </button>
        </div>
      </div>
      }

      <!-- Task List with Drag & Drop -->
      @if (tasks().length === 0) {
      <div class="text-center py-12" [@fadeIn]>
        <div class="text-6xl mb-4">üìù</div>
        <p class="text-gray-500 dark:text-gray-400 text-lg">
          @if (searchQuery() || selectedPriority() || selectedStatus() !== 'all') {
          No tasks match your filters. Try adjusting them.
          } @else {
          No tasks yet. Add your first task above!
          }
        </p>
      </div>
      } @else {
      <div cdkDropList (cdkDropListDropped)="drop($event)" class="space-y-3">
        @for (task of tasks(); track task.id) {
        <div cdkDrag
          [class]="'group p-4 border dark:border-gray-600 rounded-lg hover:shadow-md transition-all cursor-move ' + getPriorityColor(task.priority)"
          [@slideOut]>

          <!-- Drag Handle -->
          <div cdkDragHandle
            class="absolute left-2 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-50 cursor-move">
            <span class="text-gray-400 dark:text-gray-500">‚ãÆ‚ãÆ</span>
          </div>

          <div class="flex items-start justify-between gap-3 ml-4">
            <!-- Left: Checkbox and Task Info -->
            <div class="flex items-start gap-3 flex-1 min-w-0">
              <input type="checkbox" [checked]="task.completed" (click)="$event.stopPropagation()"
                (change)="toggleTask(task.id, $event)"
                class="mt-1 w-5 h-5 rounded border-gray-300 text-blue-600 focus:ring-2 focus:ring-blue-500 cursor-pointer" />

              <div class="flex-1 min-w-0" (click)="viewTask(task.id)">
                <div
                  [class]="'text-lg font-medium cursor-pointer ' + (task.completed ? 'line-through text-gray-400 dark:text-gray-500' : 'text-black dark:text-gray-100')">
                  {{ task.title }}
                  @if (isOverdue(task)) {
                  <span
                    class="ml-2 text-xs bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 px-2 py-1 rounded-full">OVERDUE</span>
                  }
                </div>

                <!-- Tags -->
                @if (task.tags.length > 0) {
                <div class="flex flex-wrap gap-1 mt-2">
                  @for (tag of task.tags; track tag) {
                  <span
                    class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded-full">
                    #{{ tag }}
                  </span>
                  }
                </div>
                }

                <!-- Subtasks Progress -->
                @if (task.subtasks.length > 0) {
                <div class="mt-2 flex items-center gap-2">
                  <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                    <div class="bg-green-500 h-2 rounded-full transition-all duration-300"
                      [style.width.%]="getSubtaskProgress(task)"></div>
                  </div>
                  <span class="text-xs text-gray-600 dark:text-gray-400">
                    {{ getSubtaskCompletedCount(task) }}/{{ task.subtasks.length }}
                  </span>
                </div>
                }

                <div class="flex flex-wrap items-center gap-2 mt-2">
                  <span
                    [class]="'text-xs px-2 py-1 rounded-full border font-semibold ' + getPriorityBadge(task.priority)">
                    {{ task.priority | uppercase }}
                  </span>

                  @if (task.dueDate) {
                  <span [class]="'text-xs ' + getDueDateColor(task)">
                    üìÖ {{ task.dueDate | date:'MMM d, y' }}
                  </span>
                  }

                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    Updated {{ task.updatedAt | date:'short' }}
                  </span>
                </div>
              </div>
            </div>

            <!-- Right: Actions -->
            <div class="flex items-center gap-2">
              <button (click)="viewTask(task.id)"
                class="px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-200 rounded hover:bg-blue-200 dark:hover:bg-blue-800 transition-colors opacity-0 group-hover:opacity-100">
                View
              </button>
              <button (click)="deleteTask(task.id, $event)"
                class="px-3 py-1 text-sm bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-200 rounded hover:bg-red-200 dark:hover:bg-red-800 transition-colors opacity-0 group-hover:opacity-100">
                Delete
              </button>
            </div>
          </div>
        </div>
        }
      </div>
      }

      <!-- Task Stats -->
      @if (allTasks().length > 0) {
      <div class="mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 text-center">
          <div class="p-3 bg-blue-50 dark:bg-blue-900/30 rounded-lg">
            <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ allTasks().length }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Total</div>
          </div>
          <div class="p-3 bg-green-50 dark:bg-green-900/30 rounded-lg">
            <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ getCompletedCount() }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Completed</div>
          </div>
          <div class="p-3 bg-orange-50 dark:bg-orange-900/30 rounded-lg">
            <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">{{ getPendingCount() }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Pending</div>
          </div>
          <div class="p-3 bg-red-50 dark:bg-red-900/30 rounded-lg">
            <div class="text-2xl font-bold text-red-600 dark:text-red-400">{{ highPriorityCount() }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">High Priority</div>
          </div>
          <div class="p-3 bg-purple-50 dark:bg-purple-900/30 rounded-lg">
            <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ tasksCompletedWeek() }}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">This Week</div>
          </div>
        </div>
      </div>
      }
    </div>
  </div>
</div>